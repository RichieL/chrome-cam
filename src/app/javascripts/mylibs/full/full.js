// Generated by CoffeeScript 1.3.3
(function() {

  define(['mylibs/utils/utils', 'text!mylibs/full/views/full.html', 'libs/webgl/glfx'], function(utils, fullTemplate) {
    var canvas, ctx, draw, frame, paused, preview, pub, webgl;
    canvas = {};
    ctx = {};
    preview = {};
    webgl = {};
    preview = {};
    paused = true;
    frame = 0;
    draw = function() {
      return $.subscribe("/camera/stream", function(stream) {
        if (!paused) {
          frame++;
          return preview.filter(webgl, stream.canvas, frame, stream.track);
        }
      });
    };
    return pub = {
      init: function(selector) {
        var $container, $content, $flash;
        $.subscribe("/capture/image", function() {
          var image, name, token;
          image = webgl.toDataURL();
          name = new Date().getTime() + ".jpg";
          token = $.subscribe("/file/saved/" + name, function() {
            $.publish("/bar/preview/update", [
              {
                thumbnailURL: image
              }
            ]);
            return $.unsubscribe(token);
          });
          return $.publish("/postman/deliver", [
            {
              name: name,
              image: image
            }, "/file/save"
          ]);
        });
        $.subscribe("/capture/video/record", function() {
          var addFrame, frames, recordBuffer, recordBufferCanvas, recordInterval, token;
          console.log("Recording...");
          recordBufferCanvas = document.createElement("canvas");
          recordBufferCanvas.width = 720 / 2;
          recordBufferCanvas.height = 480 / 2;
          recordBuffer = recordBufferCanvas.getContext("2d");
          recordBuffer.scale(0.5, 0.5);
          recordBuffer.imageSmoothingEnabled = recordBuffer.webkitImageSmoothingEnabled = false;
          frames = [];
          addFrame = function() {
            recordBuffer.drawImage(webgl, 0, 0);
            return frames.push({
              imageData: recordBufferCanvas.toDataURL('image/webp', 0.9),
              time: Date.now()
            });
          };
          recordInterval = setInterval(addFrame, 1000 / 20);
          token = $.subscribe("/camera/video/stop", function() {
            var blob, i, pair, video, _i, _len, _ref;
            console.log("Done recording!");
            frames.sort(function() {
              return 0.5 - Math.random();
            });
            video = new Whammy.Video();
            _ref = (function() {
              var _j, _ref, _results;
              _results = [];
              for (i = _j = 0, _ref = frames.length - 2; 0 <= _ref ? _j <= _ref : _j >= _ref; i = 0 <= _ref ? ++_j : --_j) {
                _results.push(frames.slice(i, i + 2));
              }
              return _results;
            })();
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              pair = _ref[_i];
              video.add(pair[0].imageData, 16);
            }
            clearInterval(recordInterval);
            blob = video.compile();
            console.log(window.URL.createObjectURL(blob));
            return $.unsubscribe(token);
          });
          return setTimeout((function() {
            return $.publish("/camera/video/stop", []);
          }), 6000);
        });
        kendo.fx.grow = {
          setup: function(element, options) {
            return $.extend({
              top: options.top,
              left: options.left,
              width: options.width,
              height: options.height
            }, options.properties);
          }
        };
        $container = $(selector);
        canvas = document.createElement("canvas");
        ctx = canvas.getContext("2d");
        $content = $(fullTemplate).appendTo($container);
        $flash = $content.find(".flash");
        webgl = fx.canvas();
        $(webgl).dblclick(function() {
          $.publish("/bar/capture/hide");
          $.publish("/camera/pause", [true]);
          return $container.kendoStop(true).kendoAnimate({
            effects: "zoomOut",
            hide: "true",
            complete: function() {
              paused = true;
              $.publish("/camera/pause", [false]);
              return $.publish("/previews/pause", [false]);
            }
          });
        });
        $content.prepend(webgl);
        $.subscribe("/full/show", function(e) {
          $.publish("/bar/capture/show");
          $.extend(preview, e);
          $.publish("/camera/pause", [true]);
          $content.height($container.height() - 50);
          $content.width((3 / 2) * $content.height());
          $(webgl).width($content.width());
          $(webgl).height("height", $content.height());
          return $container.kendoStop(true).kendoAnimate({
            effects: "zoomIn",
            show: "true",
            complete: function() {
              $.publish("/camera/pause", [false]);
              return paused = false;
            }
          });
        });
        $.subscribe("/capture/image", function() {});
        $.subscribe("/full/flash", function() {
          $flash.show();
          return $flash.kendoStop(true).kendoAnimate({
            effects: "fadeOut",
            duration: 2000,
            hide: true
          });
        });
        return draw();
      }
    };
  });

}).call(this);
