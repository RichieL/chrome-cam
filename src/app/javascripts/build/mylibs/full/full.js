// Generated by CoffeeScript 1.3.3
(function() {

  define(['mylibs/utils/utils', 'text!mylibs/full/views/full.html', 'libs/webgl/glfx'], function(utils, fullTemplate) {
    var canvas, ctx, draw, frame, paused, preview, pub, webgl;
    canvas = {};
    ctx = {};
    preview = {};
    webgl = {};
    preview = {};
    paused = true;
    frame = 0;
    draw = function() {
      return $.subscribe("/camera/stream", function(stream) {
        if (!paused) {
          frame++;
          return preview.filter(webgl, stream.canvas, frame, stream.track);
        }
      });
    };
    return pub = {
      init: function(selector) {
        var $container, $content, $flash;
        $.subscribe("/capture/image", function() {
          var image, name, token;
          image = webgl.toDataURL();
          name = new Date().getTime() + ".jpg";
          token = $.subscribe("/file/saved/" + name, function() {
            $.publish("/bar/preview/update", [
              {
                thumbnailURL: image
              }
            ]);
            $.publish("/gallery/add", [
              {
                name: name,
                image: image
              }
            ]);
            return $.unsubscribe(token);
          });
          return $.publish("/postman/deliver", [
            {
              name: name,
              image: image
            }, "/file/save"
          ]);
        });
        $.subscribe("/capture/video/record", function() {
          var frames, recordBuffer, recordBufferCanvas, stopToken, streamToken, transcode;
          console.log("Recording...");
          recordBufferCanvas = document.createElement("canvas");
          recordBufferCanvas.width = 720;
          recordBufferCanvas.height = 480;
          recordBuffer = recordBufferCanvas.getContext("2d");
          transcode = function() {
            var blob, frames, i, pair, video, _i, _len, _ref;
            video = new Whammy.Video();
            _ref = (function() {
              var _j, _ref, _results;
              _results = [];
              for (i = _j = 0, _ref = frames.length - 2; 0 <= _ref ? _j <= _ref : _j >= _ref; i = 0 <= _ref ? ++_j : --_j) {
                _results.push(frames.slice(i, i + 2));
              }
              return _results;
            })();
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              pair = _ref[_i];
              video.add(pair[0].imageData, pair[1].time - pair[0].time);
            }
            blob = video.compile();
            frames = [];
            return console.log(window.URL.createObjectURL(blob));
          };
          frames = [];
          streamToken = $.subscribe("/camera/stream", function(message) {
            return frames.push({
              imageData: message.canvas.getContext("2d").getImageData(0, 0, message.canvas.width, message.canvas.height),
              time: Date.now()
            });
          });
          stopToken = $.subscribe("/camera/video/stop", function() {
            var framesDone, i, _i, _ref, _results;
            $.unsubscribe(stopToken);
            $.unsubscribe(streamToken);
            framesDone = 0;
            _results = [];
            for (i = _i = 0, _ref = frames.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
              _results.push(setTimeout((function(i) {
                return function() {
                  recordBuffer.putImageData(frames[i].imageData, 0, 0);
                  frames[i] = {
                    imageData: recordBufferCanvas.toDataURL('image/webp', 1),
                    time: frames[i].time
                  };
                  ++framesDone;
                  if (framesDone === frames.length) {
                    return transcode();
                  }
                };
              })(i), 0));
            }
            return _results;
          });
          return setTimeout((function() {
            return $.publish("/camera/video/stop", []);
          }), 6000);
        });
        kendo.fx.grow = {
          setup: function(element, options) {
            return $.extend({
              top: options.top,
              left: options.left,
              width: options.width,
              height: options.height
            }, options.properties);
          }
        };
        $container = $(selector);
        canvas = document.createElement("canvas");
        ctx = canvas.getContext("2d");
        $content = $(fullTemplate).appendTo($container);
        $flash = $content.find(".flash");
        webgl = fx.canvas();
        $(webgl).dblclick(function() {
          $.publish("/bar/capture/hide");
          $.publish("/camera/pause", [true]);
          return $container.kendoStop(true).kendoAnimate({
            effects: "zoomOut",
            hide: "true",
            complete: function() {
              paused = true;
              $.publish("/camera/pause", [false]);
              return $.publish("/previews/pause", [false]);
            }
          });
        });
        $content.prepend(webgl);
        $.subscribe("/full/show", function(e) {
          $.publish("/bar/capture/show");
          $.extend(preview, e);
          $.publish("/camera/pause", [true]);
          $content.height($container.height() - 50);
          $content.width((3 / 2) * $content.height());
          $(webgl).width($content.width());
          $(webgl).height("height", $content.height());
          return $container.kendoStop(true).kendoAnimate({
            effects: "zoomIn",
            show: "true",
            complete: function() {
              $.publish("/camera/pause", [false]);
              return paused = false;
            }
          });
        });
        $.subscribe("/capture/image", function() {});
        $.subscribe("/full/flash", function() {
          $flash.show();
          return $flash.kendoStop(true).kendoAnimate({
            effects: "fadeOut",
            duration: 2000,
            hide: true
          });
        });
        return draw();
      }
    };
  });

}).call(this);
